<p-confirmDialog #cd [style]="{width: '40vw'}" [baseZIndex]="10000">
  <p-footer>

    <button type="button" pButton icon="pi pi-check" label="Oui" (click)="cd.accept()"></button>
    <button type="button" class="ui-button-danger" pButton icon="pi pi-times" label="Non"
      (click)="cd.reject()"></button>
  </p-footer>

</p-confirmDialog>

<p-dialog header="Importer un fichier csv" [(visible)]="fileDialog" [focusOnShow]="false" [responsive]="true"
  showEffect="fade" [modal]="true" [style]="{width: '500px'}">

  <div class="ui-g form-group">
    <p-fileUpload chooseLabel="Importer un fichier csv" name="importcsv" uploadLabel="Enrégistrer" cancelLabel="Annuler"
      accept=".txt,.csv,.xls,.xlsx" customUpload="true" (uploadHandler)="onUpload($event)">

    </p-fileUpload>

  </div>

  <p-footer>


    <button type="button" class="ui-button-danger" pButton icon="pi pi-times" (click)="cancel()"
      label="Annuler"></button>

  </p-footer>
</p-dialog>

<p-dialog header="Message" [(visible)]="responseDialog" [focusOnShow]="false" [responsive]="true" showEffect="fade"
  [modal]="true" [style]="{width: '500px'}">

  <div class="ui-g form-group">
    <p>Le nombre de lignes insérées <span style="font-weight: 900; margin-left: 10px;"> {{responsedto?.size}}</span>
    </p>

  </div>


</p-dialog>


<div class="ui-g">
  <div class="ui-g-12">
    <div class="card no-margin">
      <h3> Gestion des tiers-payants</h3>
      <p-toolbar>
        <div class="ui-toolbar-group-left ui-g-7">

          <p-autoComplete [(ngModel)]="selectedEl" [suggestions]="entites" (completeMethod)="search($event)"
            field="libelLong" [forceSelection]="true" (onSelect)="onSelect($event)" [style]="{'width':'100%'}"
            [inputStyle]="{'width':'100%'}" minLength=1>

          </p-autoComplete>
        </div>

        <div class="ui-toolbar-group-right ui-g-5">
          <button type="button" pButton icon="fa fa-file-o" iconPos="left" label="Importer un fichier csv"
            (click)="showFileDialog()" class="ui-button-warning" style="margin-right: 0.2em;"></button>
          <button type="button" pButton icon="fa fa-plus" iconPos="left" label="Nouveau tiers-payant"
            (click)="addNewEntity()"></button>

        </div>
      </p-toolbar>
      <div style="margin-top:0.2em;">
        <p-tabView>
          <p-tabPanel header="Information tiers-payant" leftIcon="fa fa-fw fa-home">
            <div class="card no-margin">
              <table *ngIf="selectedEl" class="ui-table nucleus-dataview-list">
                <tbody class="ui-table-tbody">
                  <tr>
                    <td class="firstColumn">
                      Code
                    </td>
                    <td class="secondColumn">{{selectedEl?.code}}</td>

                    <td class="firstColumn">
                      Nom
                    </td>
                    <td class="secondColumn">{{selectedEl?.libelLong}}</td>

                    <td class="firstColumn">
                      Nom Abrégé
                    </td>
                    <td class="secondColumn">{{selectedEl?.libelCourt}}</td>
                    <td class="firstColumn">
                      Groupe tiers-payant
                    </td>
                    <td class="secondColumn">{{selectedEl?.groupetpLibelle}}</td>
                  </tr>


                  <tr>
                    <td class="firstColumn">
                      Téléphone
                    </td>
                    <td class="secondColumn">{{selectedEl?.phone}}</td>

                    <td class="firstColumn">
                      Mobile
                    </td>
                    <td class="secondColumn">{{selectedEl?.mobile}}</td>

                    <td class="firstColumn">
                      Adresse
                    </td>
                    <td class="secondColumn">{{selectedEl?.address}}</td>

                    <td class="firstColumn">
                      Code comptable
                    </td>
                    <td class="secondColumn">{{selectedEl?.codeComptable}}</td>
                  </tr>

                  <tr>
                    <td class="firstColumn">
                      Montant maxi par facture
                    </td>
                    <td class="secondColumn">
                      <div *ngIf="selectedEl?.montantMaxFacture>0;then maxigt_content else maxilt"></div>
                      <ng-template #maxigt_content> {{selectedEl?.montantMaxFacture | number}}
                      </ng-template>
                      <ng-template #maxilt> Non défini</ng-template>
                    </td>

                    <td class="firstColumn">
                      Risque
                    </td>
                    <td class="secondColumn">{{selectedEl?.risqueLibelle}}</td>

                    <td class="firstColumn">
                      Modèle facture
                    </td>
                    <td class="secondColumn">{{selectedEl?.modelFactureLibelle}}</td>

                    <td class="firstColumn">
                      Plafond
                    </td>
                    <td class="secondColumn">
                      <div *ngIf="selectedEl?.plafond<=0;then other_content else content"></div>
                      <ng-template #content> {{selectedEl?.plafond | number}}
                      </ng-template>
                      <ng-template #other_content>Non défini</ng-template>

                    </td>
                  </tr>
                  <tr>
                    <td class="firstColumn">
                      Maximun de bons par facture
                    </td>
                    <td class="secondColumn">
                      <div *ngIf="selectedEl?.nbreBordereaux>0;then nbre_content else ko_content"></div>
                      <ng-template #nbre_content> {{selectedEl?.nbreBordereaux | number}}
                      </ng-template>
                      <ng-template #ko_content>Non défini</ng-template>
                    </td>

                    <td class="firstColumn">
                      Type tiers-payant
                    </td>
                    <td class="secondColumn">{{selectedEl?.typeTp}}</td>

                    <td class="firstColumn">
                      Type plafond
                    </td>
                    <td class="secondColumn">
                      <div *ngIf="selectedEl?.typePlafond;then absolu else non_absolu"></div>
                      <ng-template #absolu> Absolu </ng-template>
                      <ng-template #non_absolu> Non absolu</ng-template>

                    </td>

                    <td class="firstColumn">
                      Remise forfetaire
                    </td>
                    <td class="secondColumn">
                      {{selectedEl?.remiseForfetaire | number}}
                    </td>

                  </tr>


                </tbody>
                <tfoot>
<tr>
  <th colspan="8">

    <button type="button" pButton  class="ui-button-success" icon="fa fa-pencil-square-o" iconPos="left" label="Modifier les information du tiers-payant"
    (click)="onEdit()"></button>
  </th>
</tr>
                </tfoot>
              </table>


            </div>



          </p-tabPanel>
          <p-tabPanel header="Clients" leftIcon="fa fa-user-o">

            <!-- debut block infos client-->
            <div class="ui-g">
              <div class="ui-g-12">
                <div class="card no-margin">
                  <div style="margin-top: 10px;">
                    <p-table styleClass="ui-table-cars" [value]="clients" [paginator]="true" [rows]="itemsPerPage"
                      dataKey="id" selectionMode="single" [(selection)]="selectedClient" [lazy]="true"
                      [totalRecords]="totalItems" [loading]="loading" (onLazyLoad)="loadClient($event)"
                      [resizableColumns]="true">
                      <ng-template pTemplate="caption">
                        <div style="text-align: right;">

                          <button type="button" pButton icon="fa fa-plus" iconPos="left" label="Nouveau"
                            (click)="addNewEntity()"></button>

                        </div>

                      </ng-template>
                      <ng-template pTemplate="header">
                        <tr>
                          <th scope="col" style="width:5%"><span>Code</span> </th>
                          <th scope="col" style="width:50%"><span>Libellé</span> </th>
                          <th scope="col" style="width:15%"><span>Téléphone</span> </th>
                          <th scope="col" style="width:20%"><span>Adresse</span> </th>
                          <th scope="col" style="width:10%"></th>
                        </tr>
                        <tr>

                          <th scope="col">
                            <input [style]="{'width':'100%'}" pInputText type="text" (keyup)="onFilterTable($event)" />

                          </th>
                          <th scope="col">
                            <input [style]="{'width':'100%'}" pInputText type="text" (keyup)="onFilterTable($event)" />

                          </th>
                          <th scope="col">


                          </th>
                          <th scope="col">


                          </th>

                          <th scope="col"></th>
                        </tr>
                      </ng-template>
                      <ng-template pTemplate="body" let-elRow let-columns="columns">
                        <tr [pSelectableRow]="elRow" [pEditableRow]="elRow">
                          <td>{{ elRow.code }}</td>
                          <td>{{ elRow.libelle }}</td>
                          <td>{{ elRow.phone }}</td>
                          <td>{{ elRow.address }}</td>
                          <td style="text-align: center;">
                            <button pTooltip="Editer" pButton type="submit" class="ui-button-success"
                              icon="fa fa-pencil-square-o" style="margin-right: .5em" (click)="onEditClient(elRow)"></button>

                            <button pTooltip="Supprimer" pButton type="submit" class="ui-button-danger"
                              icon="fa fa-times-circle-o" (click)="delete(elRow)">

                            </button>
                          </td>
                        </tr>
                      </ng-template>
                      <ng-template pTemplate="emptymessage" let-columns>
                        <tr>
                          <td [attr.colspan]="5">
                            Aucune donnée trouvée
                          </td>
                        </tr>
                      </ng-template>
                    </p-table>
                  </div>
                </div>
              </div>


            </div>

            <!-- Fin block info client -->
          </p-tabPanel>
          <p-tabPanel header="Achats" leftIcon="fa fa-bitcoin">

          </p-tabPanel>

          <!-- block facture -->
          <p-tabPanel header="Factures" leftIcon="fa fa-dollar">

          </p-tabPanel>
        </p-tabView>

      </div>

    </div>


    <!-- formulaire de creation de d'un tiers-payant -->
    <form name="editForm" role="form" novalidate (ngSubmit)="save()" [formGroup]="editForm">
      <p-dialog header="Ajouter un tiers-payant" [(visible)]="displayDialog" [focusOnShow]="false" [responsive]="true"
        showEffect="fade" [modal]="true" [style]="{width: '60vw'}" [maximizable]="true">
        <p style="text-align: center;font-weight: 900;font-style: italic;">
          Les champs marqués par <span style="font-weight: 900;color: red;">*</span> sont obligatoires
        </p>
        <div class="ui-g-12 form-group">
          <div class="form-group" [hidden]="!editForm.get('id')!.value">
            <input type="hidden" class="form-control" id="id" name="id" formControlName="id" readonly />
          </div>

          <div class="ui-g-12 ui-md-6">
            <label for="field_libelle">Nom<span style="font-weight: 900;color: red;">*</span></label>
            <div style="margin-bottom:5px">
              <input type="text" pInputText class="form-control" name="libelLong" id="field_libelle"
                formControlName="libelLong" />
            </div>


          </div>
          <div class="ui-g-12 ui-md-6">

            <label for="field_libelle_cour">Nom abrégé<span style="font-weight: 900;color: red;">*</span></label>
            <div style="margin-bottom:5px">
              <input type="text" pInputText class="form-control" name="libelCourt" id="field_libelle_cour"
                formControlName="libelCourt">
            </div>


          </div>

          <div class="ui-g-12 ui-md-6">

            <label for="field_mobile">Mobile<span style="font-weight: 900;color: red;">*</span></label>
            <div style="margin-bottom:5px">
              <input type="text" pInputText class="form-control" name="mobile" id="field_mobile"
                formControlName="mobile">
            </div>


          </div>

          <div class="ui-g-12 ui-md-6">

            <label for="field_typeTp">Type tiers-payant <span style="font-weight: 900;color: red;">*</span></label>
            <div style="margin-bottom:5px">

              <p-dropdown [options]="types" styleClass="form-control" id="field_typeTp" name="typeTp"
                formControlName="typeTp" styleClass="dropdown-width" [filter]="false"
                placeholder="Séléctionner un type " itemSize="2">
              </p-dropdown>
            </div>


          </div>
          <div class="ui-g-12 ui-md-6">

            <label for="field_codeComptable">Code comptable</label>
            <div style="margin-bottom:5px">
              <input type="text" pInputText class="form-control" name="codeComptable" id="field_codeComptable"
                formControlName="codeComptable">
            </div>

          </div>
          <div class="ui-g-12 ui-md-6">

            <label for="field_groupetpId">Groupe tiers-payant</label>
            <div style="margin-bottom:5px">
              <p-dropdown [options]="groupes" styleClass="form-control" id="field_groupetpId" name="groupetpId"
                formControlName="groupetpId" styleClass="dropdown-width" [filter]="true"
                placeholder="Séléctionner un groupe " [virtualScroll]="true" itemSize="30">
              </p-dropdown>
            </div>
          </div>

          <div class="ui-g-12 ui-md-6">
            <label for="field_risqueId">Risque</label>
            <div style="margin-bottom:5px">
              <p-dropdown [options]="risques" styleClass="form-control" id="field_risqueId" name="risqueId"
                formControlName="risqueId" styleClass="dropdown-width" [filter]="true"
                placeholder="Séléctionner un risque " [virtualScroll]="true" itemSize="30">
              </p-dropdown>
            </div>
          </div>
          <div class="ui-g-12 ui-md-6">
            <label for="field_modelFactureId">Modèle de facture</label>
            <div style="margin-bottom:5px">
              <p-dropdown [options]="modelFactures" styleClass="form-control" id="field_modelFactureId"
                name="modelFactureId" formControlName="modelFactureId" styleClass="dropdown-width" [filter]="true"
                placeholder="Séléctionner un modèle de facture " [virtualScroll]="true" itemSize="30">
              </p-dropdown>
            </div>
          </div>
          <div class="ui-g-12 ui-md-6">

            <label for="field_addresse">Adresse</label>
            <div style="margin-bottom:5px">
              <input type="text" pInputText class="form-control" name="address" id="field_addresse"
                formControlName="address">
            </div>

          </div>

          <div class="ui-g-12 ui-md-3">
            <label for="field_nbreBordereaux">Maximun de bons par facture</label>
            <div style="margin-bottom:5px">
              <input type="number" pInputText class="form-control" name="nbreBordereaux" id="field_nbreBordereaux"
                formControlName="nbreBordereaux">
            </div>
          </div>
          <div class="ui-g-12 ui-md-3">
            <label for="field_montantMaxFacture">Montant maxi sur une facture</label>
            <div style="margin-bottom:5px">
              <input type="number" pInputText class="form-control" name="montantMaxFacture" id="field_montantMaxFacture"
                formControlName="montantMaxFacture">
            </div>
          </div>
          <div class="ui-g-12 ui-md-3">
            <label for="field_remiseForfetaire">Remise forfetaire</label>
            <div style="margin-bottom:5px">
              <input type="number" pInputText class="form-control" name="montantMaxFacture" id="field_remiseForfetaire"
                formControlName="remiseForfetaire">
            </div>
          </div>
          <div class="ui-g-12 ui-md-3">
            <label for="field_plafond">Plafond</label>
            <div style="margin-bottom:5px">
              <input type="number" pInputText class="form-control" name="plafond" id="field_plafond"
                formControlName="plafond">
            </div>
          </div>
          <div class="ui-g-12 ui-md-6">

            <div style="margin-top:20px">
              <p-checkbox [binary]="true" name="typePlafond" label="Le plafond est-il absolu ?" id="field_typePlafond"
                formControlName="typePlafond"></p-checkbox>
            </div>


          </div>
        </div>
        <p-footer>

          <button type="submit" [disabled]="editForm.invalid || isSaving" pButton icon="pi pi-check" (click)="save()"
            label="Enregistrer"></button>
          <button type="button" class="ui-button-danger" pButton icon="pi pi-times" (click)="cancel()"
            label="Annuler"></button>

        </p-footer>
      </p-dialog>
    </form>




  </div>